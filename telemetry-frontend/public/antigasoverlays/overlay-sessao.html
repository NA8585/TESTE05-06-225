<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Sess√£o, Status e Penalidades</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script> 
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: transparent;
      margin: 0;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      box-sizing: border-box;
    }
    .combined-status-penalties-container {
      display: flex;
      gap: 0px; 
      flex-direction: row;
      align-items: flex-start;
      color: #e5e7eb; /* Default text color for container */
    }
    .section-sessao-status, .section-penalidades-alertas {
      width: 400px; 
    }
    .overlay-section {
      background-color: rgba(17, 24, 39, 0.92); 
      border: 2px solid #1d4ed8; 
      border-radius: 1rem; 
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); 
      padding: 1rem; 
      height: 100%; 
      box-sizing: border-box;
    }
    .overlay-section h2 {
      font-size: 1.25rem; 
      font-weight: 600; 
      color: #60a5fa; 
      margin-bottom: 0.75rem; 
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
      border-bottom: 1px solid #374151; 
      padding-bottom: 0.5rem; 
    }
    .grid-display { 
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem; 
    }
    .data-pair p:first-child { /* Label styling */
      color: #9ca3af; 
      font-size: 0.875rem; 
      margin-bottom: 0.125rem; 
    }
    .data-pair p:last-child, .data-pair span#flagStatus { /* Base Value styling */
      font-weight: 600; 
      font-size: 0.95rem; 
      color: #e5e7eb; /* Default value color (gray-200) */
    }
    
    /* Specific text colors for values */
    .text-value-default { color: #e5e7eb; } /* Tailwind gray-200 */
    .text-value-session { color: #4ade80; } /* Tailwind green-400 */
    .text-value-lap { color: #e5e7eb; } 
    .text-value-incident { color: #e5e7eb; } /* Default for incidents before limit */
    .text-value-cut { color: #facc15; } /* Tailwind yellow-400 for normal cut count */
    .text-value-penalty-active { color: #ef4444; } /* Tailwind red-500 for active penalties or critical limits */
    .text-value-target { color: #60a5fa; } /* Tailwind blue-400 */
    .text-value-warning-soft { color: #facc15; } /* Yellow for soft warnings */


    .flag-status-span {
      display: flex; 
      align-items: center; 
      justify-content: center; 
      margin-top: 0.25rem; 
      padding: 0.25rem 0.75rem; 
      border-radius: 0.375rem; 
      box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); 
      font-size: 1.2rem; /* Adjusted for emojis */
      width: calc(100% - 1.5rem); /* (0.75rem * 2 padding) */
      text-align: center;
      min-height: 1.5em; /* Ensure a minimum height for the rectangle */
      line-height: 1; /* Ensure emoji is centered if it's the only content */
    }
    /* Flag specific background/text styles */
    .flag-green { background-color: #10b981; color: white; }
    .flag-yellow { background-color: #f59e0b; color: #1f2937; }
    .flag-blue { background-color: #3b82f6; color: white; }
    .flag-red { background-color: #ef4444; color: white; }
    .flag-white { background-color: #e5e7eb; color: #1f2937;}
    .flag-checkered { background-image: linear-gradient(45deg, #000 25%, transparent 25%), linear-gradient(-45deg, #000 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #000 75%), linear-gradient(-45deg, transparent 75%, #000 75%); background-size: 10px 10px; background-color: #fff; color: #000; border: 1px solid #000; }
    .flag-black { background-color: #1f2937; border: 1px solid #6b7280; color:white;}
    .flag-default { background-color: #4b5563; color: white; } 

    /* Blinking animation */
    @keyframes blink-warning {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; } /* Made blink more pronounced */
    }
    .blinking-warning {
      animation: blink-warning 0.8s infinite; /* Slightly faster blink */
    }
  </style>
</head>
<body>

  <div class="combined-status-penalties-container">
    <div class="section-sessao-status">
      <div class="overlay-section">
        <h2>Sess√£o & Status Gerais</h2>
        <div class="grid-display">
          <div class="data-pair">
            <p>Circuito</p>
            <p id="circuitName" class="font-semibold text-value-default">--</p>
          </div>
          <div class="data-pair">
            <p>Sess√£o</p>
            <p id="sessionType" class="font-semibold text-value-session">--</p>
          </div>
          <div class="data-pair">
            <p>Tempo Restante</p>
            <p id="timeRemaining" class="font-semibold text-value-default">--</p>
          </div>
          <div class="data-pair">
            <p>Volta Atual</p>
            <p id="lapInfo" class="font-semibold text-value-lap">-- / --</p>
          </div>
          <div class="data-pair">
            <p>Condi√ß√£o da Pista</p>
            <p id="trackCondition" class="font-semibold text-value-default">--</p>
          </div>
          <div class="data-pair">
            <p>Bandeira</p>
            <span id="flagStatus" class="flag-status-span flag-default"></span> 
          </div>
        </div>
      </div>
    </div>

    <div class="section-penalidades-alertas">
      <div class="overlay-section">
        <h2>Penalidades e Alertas</h2>
        <div class="grid-display">
          <div class="data-pair">
            <p>Incidentes</p>
            <p id="incidentCount" class="font-semibold text-value-incident">-- / --</p>
          </div>
          <div class="data-pair">
            <p>Penas Ativas</p>
            <p id="activePenalty" class="font-semibold text-value-penalty-active">--</p>
          </div>
          <div class="data-pair">
            <p>Avisos de Corte</p>
            <p id="cutWarning" class="font-semibold text-value-cut">-- / --</p>
          </div>
          <div class="data-pair">
            <p>Pr√≥ximo Alvo</p>
            <p id="nextTarget" class="font-semibold text-value-target">--</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const WS_URL = window.OVERLAY_WS_URL || "ws://localhost:5221/ws";
    let socket;
    const globalState = { rawYaml: null, yamlData: {} }; 

    function formatTime(totalSeconds) {
      if (totalSeconds === null || totalSeconds === undefined || totalSeconds < 0 || !isFinite(totalSeconds)) return '--';
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = Math.floor(totalSeconds % 60);
      return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    const IR_SESSION_FLAGS = { 
        Checkered: 0x00000001, White: 0x00000002, Green: 0x00000004, Yellow: 0x00000008,
        Red: 0x00000010, Blue: 0x00000020, Debris: 0x00000040, Crossed: 0x00000080,
        Black: 0x00000100, Disqualify: 0x00000200, Servicible: 0x00000400, 
        Furled: 0x00000800, Repair: 0x00001000, 
        StartHidden: 0x00010000, StartReady: 0x00020000, StartSet: 0x00040000, StartGo: 0x00080000,
        Caution: 0x01000000, CautionWaving: 0x02000000,
        OneLapToGreen: 0x10000000, GreenHeld: 0x20000000, 
    };

    function updateFlagDisplay(flagElement, flagsValue) {
        flagElement.className = 'flag-status-span flag-default'; // Reset to default background
        flagElement.innerHTML = '&nbsp;'; // Use a non-breaking space to maintain height if no emoji

        if (flagsValue === undefined || flagsValue === null) return;

        if (flagsValue & IR_SESSION_FLAGS.Checkered) { flagElement.className = 'flag-status-span flag-checkered'; flagElement.innerHTML = 'üèÅ'; }
        else if (flagsValue & IR_SESSION_FLAGS.White) { flagElement.className = 'flag-status-span flag-white'; flagElement.innerHTML = 'üè≥Ô∏è'; }
        else if (flagsValue & IR_SESSION_FLAGS.Green || flagsValue & IR_SESSION_FLAGS.StartGo || flagsValue & IR_SESSION_FLAGS.GreenHeld) { flagElement.className = 'flag-status-span flag-green'; }
        else if (flagsValue & IR_SESSION_FLAGS.Yellow || flagsValue & IR_SESSION_FLAGS.Caution || flagsValue & IR_SESSION_FLAGS.CautionWaving) { flagElement.className = 'flag-status-span flag-yellow'; }
        else if (flagsValue & IR_SESSION_FLAGS.Red) { flagElement.className = 'flag-status-span flag-red'; }
        else if (flagsValue & IR_SESSION_FLAGS.Blue) { flagElement.className = 'flag-status-span flag-blue'; }
        else if (flagsValue & IR_SESSION_FLAGS.Black || flagsValue & IR_SESSION_FLAGS.Disqualify) { flagElement.className = 'flag-status-span flag-black'; }
        else if (flagsValue & IR_SESSION_FLAGS.Debris) { flagElement.className = 'flag-status-span flag-yellow'; flagElement.innerHTML = '‚ö†Ô∏è'; } 
        else if (flagsValue & IR_SESSION_FLAGS.Repair) { flagElement.className = 'flag-status-span flag-black'; flagElement.innerHTML = 'üõ†Ô∏è'; } 
        else if (flagsValue === 0) { flagElement.className = 'flag-status-span flag-green'; } // Clear
        // else { // Fallback for other non-zero flags - REMOVED to show only color or specific emoji
        //     flagElement.innerHTML = `(${flagsValue.toString(16)})`; 
        //     flagElement.classList.add('flag-furled'); 
        // }
    }
    
    function updateElement(id, text, baseClass = 'font-semibold', colorClass = 'text-value-default', blinkingClass = '') {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = text || '--';
            // Clear previous dynamic classes
            const dynamicClasses = ['blinking-warning', 'text-value-default', 'text-value-session', 'text-value-lap', 'text-value-incident', 'text-value-cut', 'text-value-penalty-active', 'text-value-target', 'text-value-warning-soft'];
            dynamicClasses.forEach(cls => element.classList.remove(cls));
            
            // Add new classes
            element.classList.add(baseClass); // Ensure baseClass is always present
            if(colorClass) element.classList.add(colorClass);
            if(blinkingClass) element.classList.add(blinkingClass);
        }
    }


    function connectWebSocket() {
        console.log("Tentando conectar ao Sess√£oStatus WS...");
        socket = new WebSocket(WS_URL);

        socket.addEventListener("open", () => {
            console.log("Sess√£oStatus WS conectado");
            updateElement('circuitName', 'Conectado...');
        });

        socket.addEventListener("message", (event) => {
            try {
                const d = JSON.parse(event.data);
                
                if (d.SessionInfoYaml && d.SessionInfoYaml !== globalState.rawYaml) {
                    globalState.rawYaml = d.SessionInfoYaml;
                    try { globalState.yamlData = jsyaml.load(d.SessionInfoYaml) || {}; } 
                    catch (e) { console.error("Error parsing YAML for overlay-status:", e); globalState.yamlData = {}; }
                }

                const wInfo = globalState.yamlData?.WeekendInfo || {};
                const weather = globalState.yamlData?.WeekendInfo?.Weather || {}; // Corrected path to Weather
                const currentSessionInfo = globalState.yamlData?.SessionInfo || {};
                const currentSessionArr = currentSessionInfo.Sessions || [];
                const currentSessionNum = d.SessionNum; 
                const session = currentSessionArr.find(s => s.SessionNum === currentSessionNum) || {};
                const weekendOptions = wInfo.WeekendOptions || {};

                // Sess√£o & Status
                updateElement('circuitName', d.TrackName || wInfo.TrackDisplayName || '--');
                
                const timeRemain = d.SessionTimeRemain;
                let timeRemainingColor = 'text-value-default';
                let timeRemainingBlink = '';
                if (timeRemain !== null && timeRemain !== undefined && isFinite(timeRemain)) {
                    if (timeRemain <= 60 && timeRemain > 0) { 
                        timeRemainingColor = 'text-value-penalty-active';
                        timeRemainingBlink = 'blinking-warning';
                    } else if (timeRemain <= 300 && timeRemain > 0) { 
                        timeRemainingColor = 'text-value-penalty-active'; 
                    }
                }
                updateElement('timeRemaining', formatTime(timeRemain), 'font-semibold', timeRemainingColor, timeRemainingBlink);
                
                // Condi√ß√£o da Pista
                let trackCondText = '--';
                const liveTrackSurfaceMat = d.TrackSurfaceMaterial; 
                const yamlWeatherRain = weather.RainIntensity; 
                
                if (d.TrackCondition) { 
                    trackCondText = d.TrackCondition;
                } else if (yamlWeatherRain > 0.01 || liveTrackSurfaceMat === 2 ) {
                    trackCondText = 'Molhada';
                } else if (liveTrackSurfaceMat === 1 || (yamlWeatherRain !== undefined && yamlWeatherRain <= 0.01)) {
                    trackCondText = 'Seca';
                } else if (wInfo.TrackWeatherType) { 
                    trackCondText = wInfo.TrackWeatherType;
                }
                updateElement('trackCondition', trackCondText);
                
                let sessionTypeDisplay = d.SessionType || session.SessionType || session.SessionName || d.SessionState || '--';
                updateElement('sessionType', sessionTypeDisplay, 'font-semibold', 'text-value-session');
                
                const currentLap = d.Lap ?? 0;
                const totalLaps = parseInt(d.SessionLapsTotal ?? session.SessionLapsTotal) || 0; 
                let lapInfoColor = 'text-value-lap';
                let lapInfoBlink = '';
                if (totalLaps > 0) { // Only apply warnings if totalLaps is known and positive
                    if (currentLap >= totalLaps) {
                        lapInfoColor = 'text-value-penalty-active';
                        lapInfoBlink = 'blinking-warning';
                    } else if (totalLaps - currentLap <= 2) { // 2 or less laps remaining
                        lapInfoColor = 'text-value-penalty-active'; 
                    }
                }
                updateElement('lapInfo', `${currentLap} / ${totalLaps > 0 ? totalLaps : '‚àû'}`, 'font-semibold', lapInfoColor, lapInfoBlink);
                
                updateFlagDisplay(document.getElementById('flagStatus'), d.SessionFlags); 

                // Penalidades & Alertas
                const incidentLimit = parseInt(weekendOptions.IncidentLimit ?? session?.ResultsPenalty?.IncidentLimit ?? d.IncidentLimit) || Infinity;
                const currentIncidents = d.PlayerCarTeamIncidentCount ?? 0; 
                let incidentColorClass = 'text-value-incident';
                let incidentBlinkingClass = '';
                if (incidentLimit !== Infinity && currentIncidents > 0) {
                    if (currentIncidents >= incidentLimit) {
                        incidentColorClass = 'text-value-penalty-active';
                        incidentBlinkingClass = 'blinking-warning';
                    } else if (currentIncidents >= incidentLimit - 2) { 
                        incidentColorClass = 'text-value-penalty-active';
                    }
                }
                updateElement('incidentCount', `${currentIncidents} / ${incidentLimit === Infinity ? 'N/A' : incidentLimit}`, 'font-semibold', incidentColorClass, incidentBlinkingClass);
                
                const cutWarningLimit = parseInt(weekendOptions.CutTrackWarningsLimit ?? d.CutWarningLimit) || Infinity; 
                const currentCutWarnings = d.PlayerCarTrackCutWarnings ?? d.CutWarnings ?? 0; 
                let cutColorClass = 'text-value-cut'; 
                let cutBlinkingClass = '';
                 if (cutWarningLimit !== Infinity && currentCutWarnings > 0) {
                    if (currentCutWarnings >= cutWarningLimit) {
                        cutColorClass = 'text-value-penalty-active'; 
                        cutBlinkingClass = 'blinking-warning';
                    } else if (currentCutWarnings >= cutWarningLimit -1 ) { 
                         cutColorClass = 'text-value-penalty-active'; 
                    }
                }
                updateElement('cutWarning', `${currentCutWarnings} / ${cutWarningLimit === Infinity ? 'N/A' : cutWarningLimit}`, 'font-semibold', cutColorClass, cutBlinkingClass); 
                
                updateElement('activePenalty', d.ActivePenalties || (d.PlayerCarSLFirst === 1 ? 'Stop&Go' : (d.PlayerCarSLSecond === 1 ? 'DriveThru' : '--')), 'font-semibold', 'text-value-penalty-active'); 
                updateElement('nextTarget', d.NextTarget || '--', 'font-semibold', 'text-value-target');

            } catch (error) {
                console.error("Error processing WebSocket message in overlay-status:", error, "Raw data:", event.data);
            }
        });

        socket.addEventListener("close", () => {
            console.log("Sess√£oStatus WS desconectado. Tentando reconectar em 3s...");
            updateElement('circuitName', 'Desconectado', 'font-semibold', 'text-value-penalty-active'); 
            setTimeout(connectWebSocket, 3000); 
        });

        socket.addEventListener("error", (error) => {
            console.error("Sess√£oStatus WS Error:", error);
            updateElement('circuitName', 'Erro WS', 'font-semibold', 'text-value-penalty-active'); 
            if (socket && socket.readyState !== WebSocket.CLOSED) {
                socket.close();
            }
        });
    }

    connectWebSocket(); 

  </script>
</body>
</html>
